@inherits LayoutComponentBase
@using SmartEdu.Shared.Services
@inject INetworkService NetworkService
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@inject IBatteryService BatteryService
@inject IScreenshotService ScreenshotService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav


<HeadContent>
    <link href="css/shared/app.css" rel="stylesheet" />
</HeadContent>


<div class="page">
    <main>
        <div class="top-row px-4">

            <div class="network-indicator">
                @if (isConnected)
                {
                    <span class="status-online">🟢 Online</span>
                }
                else
                {
                    <span class="status-offline">🔴 No Internet Connection</span>
                }
            </div>

            <div class="battery-container" title="@batteryState">

                <span class="battery-text" style="color: @batteryColor;">
                    @batteryPercentage%
                </span>

                <span class="battery-icon">@batteryIcon</span>
            </div>

            <button class="btn-screenshot" @onclick="TakeScreenshot" title="Capture Screen">
                📸
            </button>

            <AuthorizeView>
                <Authorized>
                    <button class="btn-logout-top" @onclick="HandleLogout" title="Log Out" style="width: auto; padding: 0 10px; font-size: 1rem;">
                        Log Out
                    </button>
                </Authorized>
            </AuthorizeView>

        </div>

        <article class="content">
            @Body
        </article>
    </main>
</div>


@* <div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div> *@


@code {
    private bool isConnected = true;

    private string batteryPercentage = "0";
    private string batteryState = "Unknown";
    private string batteryIcon = "🔋";
    private string batteryColor = "#E8E8E8"; 

    protected override void OnInitialized()
    {
        // Cek status awal
        isConnected = NetworkService.IsConnected;
        // Langganan event jika status berubah
        NetworkService.ConnectivityChanged += HandleConnectivityChanged;
        CheckBattery();
    }

    private void HandleConnectivityChanged(bool status)
    {
        isConnected = status;
        // Refresh UI karena event ini dipanggil dari background thread sistem
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // Wajib lepas event handler saat halaman ditutup
        NetworkService.ConnectivityChanged -= HandleConnectivityChanged;
    }
    private void CheckBattery()
    {
        try
        {
            var level = BatteryService.GetLevel(); // Dapat angka 0.0 - 1.0
            var state = BatteryService.GetState();

            // Konversi ke Persen
            int percent = (int)(level * 100);
            batteryPercentage = percent.ToString();
            batteryState = state;

            // Logika Warna & Ikon
            if (percent > 80)
            {
                batteryColor = "#4CAF50"; // Hijau
                batteryIcon = "🔋";
            }
            else if (percent > 20)
            {
                batteryColor = "#FFC107"; // Kuning
                batteryIcon = "🪫";
            }
            else
            {
                batteryColor = "#FF5252"; // Merah
                batteryIcon = "🪫";
            }

            // Cek jika sedang di-charge
            if (state == "Charging" || state == "Full")
            {
                batteryIcon = "⚡ " + batteryIcon;
                batteryColor = "#00E676"; // Hijau Terang Charging
            }
        }
        catch
        {
            batteryPercentage = "--";
        }
    }
    private async Task TakeScreenshot()
    {
        // Panggil fungsi screenshot
        await ScreenshotService.CaptureandShareAsync();
    }

    private async Task HandleLogout()
    {
        var customAuthState = (CustomAuthStateProvider)AuthStateProvider;
        await customAuthState.UpdateAuthenticationState(null);
        Nav.NavigateTo("/", true);
    }
}