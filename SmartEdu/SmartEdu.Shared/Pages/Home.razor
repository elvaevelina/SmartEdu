@page "/"
@using System.Net.Http.Json
@using SmartEdu.Shared.Models
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime


<div class="hero-section">
    <h1 class="system-title">SmartEdu</h1>
    <p class="system-subtitle">Hybrid Learning Management System for Modern Education</p>
</div>

<div class="search-bar">
    <input type="text" @bind="SearchQuery" @bind:event="oninput" placeholder="Search courses or trainers..." />
    <span class="search-icon" @onclick="SearchAsync">🔍</span>
</div>

<!-- COURSES  -->
<div class="content-section">
    <h2 class="section-title">Published Courses</h2>

    <div class="add-course-container">
        <NavLink class="add-course-btn" href="addcourse">
            <span class="plus-icon">+</span> Add Course
        </NavLink>
    </div>


    @if (Courses == null)
    {
        <p class="loading-text">Loading courses...</p>
    }
    else if (!Courses.Any())
    {
        <p class="loading-text">No courses available.</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var course in Courses)
            {
                <div class="course-card">
                    <div class="course-card-header">
                        <div class="course-icon">📘</div>
                        <h3>@course.Title</h3>
                    </div>
                    <div class="course-card-body">
                        <p>@course.Description</p>
                    </div>
                    <div class="course-card-footer">
                        <span class="duration">@course.DurationInHours Hours</span>
                        <div class="course-action">
                            <button class="btn-edit" @onclick="() => UpdateCourse(course.IdCourse)">✏️ Edit</button>
                            <button class="btn-delete" @onclick="() => DeleteCourse(course.IdCourse)">🗑️ Delete</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- TRAINERS  -->
<div class="content-section">
    <h2 class="section-title">Our Trainers</h2>

    <div class="add-trainer-container">
        <NavLink class="add-trainer-btn" href="addtrainer">
            <span class="plus-icon">+</span> Add Trainer
        </NavLink>
    </div>

    @if (Trainers == null)
    {
        <p class="loading-text">Loading trainers...</p>
    }
    else if (!Trainers.Any())
    {
        <p class="loading-text">No trainers available.</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var trainer in Trainers)
            {
                <div class="trainer-card">
                    <div class="trainer-avatar">👨‍🏫</div>
                    <div class="trainer-info">
                        <h3>@trainer.Name</h3>
                        <p>@trainer.Email</p>
                        <p class="trainer-phone">@trainer.Phone</p>
                    </div>
                    <div class="trainer-action">
                        <button class="btn-edit" @onclick="() => UpdateTrainer(trainer.IdTrainer)">✏️ Edit</button>
                        <button class="btn-delete" @onclick="() => DeleteTrainer(trainer.IdTrainer)">🗑️ Delete</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Course>? Courses;
    private List<Trainer>? Trainers;
    private string SearchQuery = string.Empty;

    public class SearchResult
    {
        public List<Course> Courses { get; set; } = new();
        public List<Trainer> Trainers { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = new HttpClient { BaseAddress = new Uri("https://localhost:7194/") };
            Courses = await http.GetFromJsonAsync<List<Course>>("api/courses");
            Trainers = await http.GetFromJsonAsync<List<Trainer>>("api/trainers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            Courses = new();
            Trainers = new();
        }
    }
    private async Task SearchAsync()
    {
        try
        {
            using var http = new HttpClient { BaseAddress = new Uri("https://localhost:7194/") };
            if(string.IsNullOrWhiteSpace(SearchQuery))
            {
                Courses = await http.GetFromJsonAsync<List<Course>>("api/courses");
                Trainers = await http.GetFromJsonAsync<List<Trainer>>("api/trainers");
            }

            else
            {
                var query = System.Web.HttpUtility.UrlEncode(SearchQuery);

                var response = await http.GetFromJsonAsync<SearchResult>($"api/search?query={query}");

                if (response != null)
                {
                    Courses = response.Courses;
                    Trainers = response.Trainers;
                }
                else
                {
                    Courses = new();
                    Trainers = new();
                }
            }    
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during search: {ex.Message}");
            Courses = new();
            Trainers = new();
        }
    }
    private void UpdateCourse(int IdCourse)
    {
        Nav.NavigateTo($"/updatecourse/{IdCourse}");
    }
    private async Task DeleteCourse(int courseId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this course?");
        if (confirmed)
        {
            try
            {
                using var http = new HttpClient { BaseAddress = new Uri("https://localhost:7194/") };
                var response = await http.DeleteAsync($"api/courses/{courseId}");

                if (response.IsSuccessStatusCode)
                {
                    Courses?.RemoveAll(c => c.IdCourse == courseId);
                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine($"Failed to delete course. Status: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting course: {ex.Message}");
            }
        }
    }
    private void UpdateTrainer(int IdTrainer)
    {
        Nav.NavigateTo($"/updatetrainer/{IdTrainer}");
    }
    private async Task DeleteTrainer(int trainerId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this trainer?");
        if (confirmed)
        {
            try
            {
                using var http = new HttpClient { BaseAddress = new Uri("https://localhost:7194/") };
                var response = await http.DeleteAsync($"api/trainers/{trainerId}");
                if (response.IsSuccessStatusCode)
                {
                    Trainers?.RemoveAll(t => t.IdTrainer == trainerId);
                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine($"Failed to delete trainer. Status: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting trainer: {ex.Message}");
            }
        }
    }
}
