@page "/courses"
@using System.Net.Http.Json
@using SmartEdu.Shared.Models
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<div class="hero-section">
    <h1 class="system-title">Courses</h1>
    <p class="system-subtitle">Explore our available learning materials</p>
</div>

<div class="search-bar">
    <input type="text" @bind="SearchQuery" @bind:event="oninput" placeholder="Search courses..." />
    <span class="search-icon" @onclick="SearchAsync">🔍</span>
</div>

<div class="content-section">
    <div class="add-course-container">
        <NavLink class="add-course-btn" href="addcourse">
            <span class="plus-icon">+</span> Add Course
        </NavLink>
    </div>

    @if (Courses == null)
    {
        <p class="loading-text">Loading courses...</p>
    }
    else if (!Courses.Any())
    {
        <p class="loading-text">No courses available.</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var course in Courses)
            {
                <div class="course-card">
                    <div class="course-card-header">
                        <div class="course-icon">📘</div>
                        <h3>@course.Title</h3>
                    </div>
                    <div class="course-card-body">
                        <p>@course.Description</p>
                    </div>
                    <div class="course-card-footer">
                        <span class="duration">@course.DurationInHours Hours</span>
                        <div class="course-image-container">
                            @if (!string.IsNullOrEmpty(course.ImageUrl))
                            {
                                <img src="@($"{Http.BaseAddress}Uploads/{course.ImageUrl}")"
                                     alt="@course.Title"
                                     class="course-image"
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     @onerror="e => { course.ImageUrl = null; }" />
                            }
                            else
                            {
                                <div class="no-image-placeholder">
                                    <span>No Image</span>
                                </div>
                            }
                        </div>
                        <div class="course-action">
                            <button class="btn-edit" @onclick="() => UpdateCourse(course.IdCourse)">✏️ Edit</button>
                            <button class="btn-delete" @onclick="() => DeleteCourse(course.IdCourse)">🗑️ Delete</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <div style="margin-top: 30px; text-align:center;">
        <button class="btn-cancel" @onclick='() => Nav.NavigateTo("/")'>Back to Home</button>
    </div>

</div>

@code {
    private List<Course>? Courses;
    private string SearchQuery = string.Empty;

    // Struktur untuk menampung hasil search API (meskipun kita cuma pakai Courses)
    public class SearchResult
    {
        public List<Course> Courses { get; set; } = new();
        public List<Trainer> Trainers { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCourses();
    }

    private async Task LoadCourses()
    {
        try
        {
            Courses = await Http.GetFromJsonAsync<List<Course>>("api/courses");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            Courses = new();
        }
    }

    private async Task SearchAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(SearchQuery))
            {
                await LoadCourses();
            }
            else
            {
                var query = System.Web.HttpUtility.UrlEncode(SearchQuery);
                // Kita gunakan API search yang sama, tapi hanya ambil properti Courses
                var response = await Http.GetFromJsonAsync<SearchResult>($"api/search?query={query}");

                if (response != null)
                {
                    Courses = response.Courses;
                }
                else
                {
                    Courses = new();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during search: {ex.Message}");
            Courses = new();
        }
    }

    private void UpdateCourse(int IdCourse)
    {
        Nav.NavigateTo($"/updatecourse/{IdCourse}");
    }

    private async Task DeleteCourse(int courseId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this course?");
        if (confirmed)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/courses/{courseId}");

                if (response.IsSuccessStatusCode)
                {
                    Courses?.RemoveAll(c => c.IdCourse == courseId);
                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine($"Failed to delete course. Status: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting course: {ex.Message}");
            }
        }
    }
}