@page "/trainers"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.Net.Http.Json
@using SmartEdu.Shared.Models
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<div class="hero-section">
    <h1 class="system-title">Trainers</h1>
    <p class="system-subtitle">Meet our professional instructors</p>
</div>

<div class="search-bar">
    <input type="text" @bind="SearchQuery" @bind:event="oninput" placeholder="Search trainers..." />
    <span class="search-icon" @onclick="SearchAsync">🔍</span>
</div>

<div class="content-section">
    <div class="add-trainer-container">
        <NavLink class="add-trainer-btn" href="addtrainer">
            <span class="plus-icon">+</span> Add Trainer
        </NavLink>
    </div>

    @if (Trainers == null)
    {
        <p class="loading-text">Loading trainers...</p>
    }
    else if (!Trainers.Any())
    {
        <p class="loading-text">No trainers available.</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var trainer in Trainers)
            {
                <div class="trainer-card">
                    <div class="trainer-avatar">👨‍🏫</div>
                    <div class="trainer-info" @onclick="() => NavigateToDetail(trainer.IdTrainer)" style="cursor:pointer;">
                        <h3>@trainer.Name</h3>
                        <p>@trainer.Email</p>
                        <p class="trainer-phone">@trainer.Phone</p>
                        <div class="trainer-image-container">
                            @if (!string.IsNullOrEmpty(trainer.ImageUrl))
                            {
                                <img src="@($"{Http.BaseAddress}Uploads/{trainer.ImageUrl}")"
                                     alt="@trainer.Name"
                                     class="trainer-image"
                                     @onerror="e => { trainer.ImageUrl = null; }" />
                            }
                            else
                            {
                                <div class="no-image-placeholder">
                                    <span>No Image</span>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="trainer-action">
                        <button class="btn-edit" @onclick="() => UpdateTrainer(trainer.IdTrainer)">✏️ Edit</button>
                        <button class="btn-delete" @onclick="() => DeleteTrainer(trainer.IdTrainer)">🗑️ Delete</button>
                    </div>
                </div>
            }
        </div>
    }

    <div style="margin-top: 30px; text-align:center;">
        <button class="btn-cancel" @onclick='() => Nav.NavigateTo("/home")'>Back to Home</button>
    </div>

</div>

@code {
    private List<Trainer>? Trainers;
    private string SearchQuery = string.Empty;

    public class SearchResult
    {
        public List<Course> Courses { get; set; } = new();
        public List<Trainer> Trainers { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTrainers();
    }

    private async Task LoadTrainers()
    {
        try
        {
            Trainers = await Http.GetFromJsonAsync<List<Trainer>>("api/trainers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            Trainers = new();
        }
    }

    private async Task SearchAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(SearchQuery))
            {
                await LoadTrainers();
            }
            else
            {
                var query = System.Web.HttpUtility.UrlEncode(SearchQuery);
                var response = await Http.GetFromJsonAsync<SearchResult>($"api/search?query={query}");

                if (response != null)
                {
                    Trainers = response.Trainers;
                }
                else
                {
                    Trainers = new();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during search: {ex.Message}");
            Trainers = new();
        }
    }

    private void UpdateTrainer(int IdTrainer)
    {
        Nav.NavigateTo($"/updatetrainer/{IdTrainer}");
    }

    private async Task DeleteTrainer(int trainerId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this trainer?");
        if (confirmed)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/trainers/{trainerId}");
                if (response.IsSuccessStatusCode)
                {
                    Trainers?.RemoveAll(t => t.IdTrainer == trainerId);
                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine($"Failed to delete trainer. Status: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting trainer: {ex.Message}");
            }
        }
    }

    private void NavigateToDetail(int trainerId)
    {
        Nav.NavigateTo($"/trainerdetail/{trainerId}");
    }
}